"use client"

import { useRouter } from "next/navigation"
import { useState, useMemo, useEffect } from "react"
import useSWR from "swr"
import { Header } from "@/components/layout/header"
import { Footer } from "@/components/layout/footer"
import { Card } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Search } from "lucide-react"

// Dashboard components
import { QuickActionSection, CardsSection } from "@/components/dashboard/cards-section"
import { YearlyProfitSection } from "@/components/dashboard/yearly-profit-section"

// Types
import type { DashboardCard } from "@/types"
import { saveBackupToCache } from "@/lib/backup-cache"

// Dashboard cards configuration
const ALL_CARDS: DashboardCard[] = [
  // Quick Action
  { id: "planning", section: "Quick Action", title: "Planning", keywords: "planning project plan", route: "/planning", icon: "calendar" },
  { id: "quotation", section: "Quick Action", title: "Quotation", keywords: "quotation quote qtn", route: "/quotation", icon: "file-check" },
  { id: "invoice", section: "Quick Action", title: "Invoice", keywords: "invoice inv payment bill", route: "/invoice", icon: "receipt" },
  { id: "expenses", section: "Quick Action", title: "Expenses", keywords: "expenses expense exp cost", route: "/expense", icon: "wallet" },
  { id: "production-tracker", section: "Quick Action", title: "Tracker", keywords: "tracker production entry expenses actual", route: "/special-case/production-tracker", icon: "table" },
  
  // Special Case
  { id: "paragon", section: "Special Case", title: "Paragon", keywords: "paragon special", route: "/special-case/paragon", icon: "building" },
  { id: "erha", section: "Special Case", title: "Erha", keywords: "erha special", route: "/special-case/erha", icon: "building" },
  { id: "gear-expenses", section: "Special Case", title: "Gear Expenses", keywords: "gear expenses equipment", route: "/special-case/gear-expenses", icon: "wallet" },
  { id: "big-expenses", section: "Special Case", title: "Big Expenses", keywords: "big expenses large", route: "/special-case/big-expenses", icon: "wallet" },
  
  // Management
  { id: "companies", section: "Management", title: "Companies", keywords: "companies company client master", route: "/companies", icon: "building" },
  { id: "billings", section: "Management", title: "Billings", keywords: "billings billing bank account master", route: "/billings", icon: "file-text" },
  { id: "signatures", section: "Management", title: "Signatures", keywords: "signatures signature sign master", route: "/signatures", icon: "file-signature" },
  { id: "products", section: "Management", title: "Products", keywords: "products product master", route: "/products", icon: "package" },
  { id: "templates", section: "Management", title: "Templates", keywords: "templates template quotation master", route: "/templates", icon: "package-open" },
]

export default function Home() {
  const router = useRouter()
  
  // State management
  const [searchQuery, setSearchQuery] = useState("")
  const [currentYear, setCurrentYear] = useState<string>("")
  const [availableYears, setAvailableYears] = useState<number[]>([])
  const [isClient, setIsClient] = useState(false)

  // Initialize client-side state
  useEffect(() => {
    setIsClient(true)
    const year = new Date().getFullYear().toString()
    setCurrentYear(year)
  }, [])

  // First landing: trigger backup if not run in last 24h; cache 1 day so we don't call every visit.
  // When backup is triggered, backup data is returned and stored in IndexedDB (copy off the DB).
  useEffect(() => {
    if (!isClient) return
    const CACHE_KEY = "backup_trigger_until"
    const ONE_DAY_MS = 24 * 60 * 60 * 1000
    const cached = typeof sessionStorage !== "undefined" ? sessionStorage.getItem(CACHE_KEY) : null
    const until = cached ? parseInt(cached, 10) : 0
    if (Date.now() < until) return
    fetch("/api/backup/trigger")
      .then((res) => res.json())
      .then((body) => {
        if (body.triggered || body.nextEligibleAt) {
          sessionStorage.setItem(CACHE_KEY, String(Date.now() + ONE_DAY_MS))
        }
        if (body.backupData) {
          saveBackupToCache(body.backupData).catch(() => {})
        }
      })
      .catch(() => {})
  }, [isClient])

  // Fetch profit data with SWR for automatic caching and deduplication
  const { data: profitData, isLoading } = useSWR(
    isClient && currentYear ? `/api/yearly-profit?year=${currentYear}` : null,
    (url: string) => fetch(url).then(res => res.json()),
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: false,
      dedupingInterval: 10000, // Dedupe requests within 10 seconds
    }
  )

  // Update available years when profit data changes
  useEffect(() => {
    if (profitData?.availableYears) {
      setAvailableYears(profitData.availableYears)
    }
  }, [profitData])

  const grossProfit = profitData?.grossProfit || 0
  const netProfit = profitData?.netProfit || 0

  // Format currency
  const formatCurrency = (amount: number) => {
    if (!isClient) return "Rp 0"
    return new Intl.NumberFormat("id-ID", {
      style: "currency",
      currency: "IDR",
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(amount)
  }

  // Navigation handler
  const handleNavigate = (path: string) => {
    router.push(path)
  }

  // Filter cards based on search
  const filteredCards = useMemo(() => {
    if (!searchQuery.trim()) return ALL_CARDS
    const query = searchQuery.toLowerCase()
    return ALL_CARDS.filter(
      (card) =>
        card.title.toLowerCase().includes(query) ||
        card.keywords.toLowerCase().includes(query) ||
        card.section.toLowerCase().includes(query)
    )
  }, [searchQuery])

  // Group cards by section
  const cardsBySection = useMemo(() => {
    const sections: { [key: string]: DashboardCard[] } = {
      "Quick Action": [],
      "Special Case": [],
      Management: [],
    }
    filteredCards.forEach((card) => {
      sections[card.section].push(card)
    })
    return sections
  }, [filteredCards])

  return (
    <div className="flex min-h-screen flex-col">
      <Header />
      
      <main className="flex flex-1 flex-col bg-gradient-to-br from-background via-background to-muted px-4 pt-8 pb-12">
        <div className="container mx-auto max-w-7xl space-y-8">
          {/* Search Bar */}
          <div className="relative w-full">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              type="text"
              placeholder="Search pages... (e.g., invoice, planning, products)"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-9"
            />
            {searchQuery && (
              <Button
                variant="ghost"
                size="sm"
                className="absolute right-1 top-1/2 -translate-y-1/2 h-7 px-2"
                onClick={() => setSearchQuery("")}
              >
                âœ•
              </Button>
            )}
          </div>

          {/* No results message */}
          {searchQuery && filteredCards.length === 0 && (
            <Card className="p-8 text-center">
              <p className="text-muted-foreground">
                No pages found matching &quot;{searchQuery}&quot;
              </p>
              <Button
                variant="link"
                onClick={() => setSearchQuery("")}
                className="mt-2"
              >
                Clear search
              </Button>
            </Card>
          )}

          {/* Quick Action Section */}
          {cardsBySection["Quick Action"].length > 0 && (
            <QuickActionSection
              cards={cardsBySection["Quick Action"]}
              onNavigate={handleNavigate}
            />
          )}

          {/* Yearly Profit Section */}
          {!searchQuery && isClient && (
            <YearlyProfitSection
              grossProfit={grossProfit}
              netProfit={netProfit}
              selectedYear={currentYear}
              availableYears={availableYears}
              onYearChange={setCurrentYear}
              loading={isLoading}
              formatCurrency={formatCurrency}
            />
          )}

          {/* Special Case Section */}
          {cardsBySection["Special Case"].length > 0 && (
            <CardsSection
              cards={cardsBySection["Special Case"]}
              sectionTitle="Special Case"
              onNavigate={handleNavigate}
            />
          )}

          {/* Management Section */}
          {cardsBySection["Management"].length > 0 && (
            <CardsSection
              cards={cardsBySection["Management"]}
              sectionTitle="Management"
              onNavigate={handleNavigate}
            />
          )}
        </div>
      </main>
      
      <Footer />
    </div>
  )
}
