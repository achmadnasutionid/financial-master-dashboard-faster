generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Company {
  id         String    @id @default(cuid())
  name       String    @unique
  address    String
  city       String
  province   String
  postalCode String?
  telp       String?
  email      String?
  deletedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([deletedAt])
}

model Billing {
  id              String    @id @default(cuid())
  name            String    @unique
  bankName        String
  bankAccount     String
  bankAccountName String
  ktp             String?
  npwp            String?
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([deletedAt])
}

model Signature {
  id        String    @id @default(cuid())
  name      String    @unique
  role      String?
  imageData String
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model Product {
  id        String          @id @default(cuid())
  name      String          @unique
  deletedAt DateTime?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  details   ProductDetail[]

  @@index([deletedAt])
}

model ProductDetail {
  id        String    @id @default(cuid())
  productId String
  detail    String
  unitPrice Float
  qty       Float
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  product   Product   @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([deletedAt])
}

model Quotation {
  id                     String               @id @default(cuid())
  quotationId            String               @unique
  companyName            String
  companyAddress         String
  companyCity            String
  companyProvince        String
  companyPostalCode      String?
  companyTelp            String?
  companyEmail           String?
  productionDate         DateTime
  billTo                 String
  billToEmail            String?
  notes                  String?
  billingName            String
  billingBankName        String
  billingBankAccount     String
  billingBankAccountName String
  billingKtp             String?
  billingNpwp            String?
  signatureName          String
  signatureRole          String?
  signatureImageData     String
  pph                    String
  totalAmount            Float
  summaryOrder           String?              @default("subtotal,pph,total")
  adjustmentPercentage   Float?
  adjustmentNotes        String?
  termsAndConditions     String?
  status                 String               @default("draft")
  generatedInvoiceId     String?              @unique
  generatedInvoice       Invoice?             @relation("GeneratedFromQuotation")
  deletedAt              DateTime?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  items                  QuotationItem[]
  remarks                QuotationRemark[]
  signatures             QuotationSignature[]

  @@index([status, deletedAt])
  @@index([quotationId])
  @@index([productionDate])
  @@index([updatedAt])
  @@index([productionDate, status, deletedAt])
  @@index([status, updatedAt, deletedAt])
  @@index([companyName])
  @@index([generatedInvoiceId])
  // NEW: Optimized indexes for dashboard queries
  @@index([status, productionDate, deletedAt]) // Pending/accepted quotations by year
  @@index([deletedAt, updatedAt])              // Recent activity queries
  @@index([status, totalAmount, deletedAt])    // Financial stats by status
}

model QuotationItem {
  id          String                @id @default(cuid())
  quotationId String
  productName String
  total       Float
  order       Int                   @default(0)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  quotation   Quotation             @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  details     QuotationItemDetail[]

  @@index([quotationId])
  @@index([quotationId, order])
}

model QuotationItemDetail {
  id              String        @id @default(cuid())
  quotationItemId String
  detail          String
  unitPrice       Float
  qty             Float
  amount          Float
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  quotationItem   QuotationItem @relation(fields: [quotationItemId], references: [id], onDelete: Cascade)

  @@index([quotationItemId])
}

model QuotationRemark {
  id          String    @id @default(cuid())
  quotationId String
  text        String
  isCompleted Boolean   @default(false)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@index([quotationId])
  @@index([quotationId, order])
}

model QuotationSignature {
  id          String    @id @default(cuid())
  quotationId String
  name        String
  position    String
  imageData   String
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)

  @@index([quotationId])
  @@index([quotationId, order])
}

model Invoice {
  id                     String             @id @default(cuid())
  invoiceId              String             @unique
  companyName            String
  companyAddress         String
  companyCity            String
  companyProvince        String
  companyPostalCode      String?
  companyTelp            String?
  companyEmail           String?
  productionDate         DateTime
  paidDate               DateTime?
  billTo                 String
  billToEmail            String?
  notes                  String?
  billingName            String
  billingBankName        String
  billingBankAccount     String
  billingBankAccountName String
  billingKtp             String?
  billingNpwp            String?
  signatureName          String
  signatureRole          String?
  signatureImageData     String
  pph                    String
  totalAmount            Float
  summaryOrder           String?            @default("subtotal,pph,total")
  adjustmentPercentage   Float?
  adjustmentNotes        String?
  termsAndConditions     String?
  status                 String             @default("draft")
  generatedExpenseId     String?            @unique
  generatedExpense       Expense?           @relation("GeneratedFromInvoice")
  sourceQuotationId      String?            @unique
  sourceQuotation        Quotation?         @relation("GeneratedFromQuotation", fields: [sourceQuotationId], references: [id], onDelete: SetNull)
  deletedAt              DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  items                  InvoiceItem[]
  remarks                InvoiceRemark[]
  signatures             InvoiceSignature[]

  @@index([status, deletedAt])
  @@index([invoiceId])
  @@index([productionDate])
  @@index([updatedAt])
  @@index([productionDate, status, deletedAt])
  @@index([status, updatedAt, deletedAt])
  @@index([companyName])
  @@index([paidDate, status, deletedAt])
  @@index([generatedExpenseId])
  @@index([sourceQuotationId])
  // NEW: Optimized indexes for dashboard queries
  @@index([status, productionDate, deletedAt]) // Pending/paid invoices by year
  @@index([deletedAt, updatedAt])              // Recent activity queries
  @@index([status, totalAmount, deletedAt])    // Financial stats by status
}

model InvoiceItem {
  id          String              @id @default(cuid())
  invoiceId   String
  productName String
  total       Float
  order       Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  invoice     Invoice             @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  details     InvoiceItemDetail[]

  @@index([invoiceId])
  @@index([invoiceId, order])
}

model InvoiceItemDetail {
  id            String      @id @default(cuid())
  invoiceItemId String
  detail        String
  unitPrice     Float
  qty           Float
  amount        Float
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  invoiceItem   InvoiceItem @relation(fields: [invoiceItemId], references: [id], onDelete: Cascade)

  @@index([invoiceItemId])
}

model InvoiceRemark {
  id          String   @id @default(cuid())
  invoiceId   String
  text        String
  isCompleted Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([invoiceId, order])
}

model InvoiceSignature {
  id        String   @id @default(cuid())
  invoiceId String
  name      String
  position  String
  imageData String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([invoiceId, order])
}

model Expense {
  id                    String        @id @default(cuid())
  expenseId             String        @unique
  invoiceId             String?
  // Snapshot fields for invoice reference (no FK cascade)
  invoiceNumber         String?
  invoiceProductionDate DateTime?
  invoiceTotalAmount    Float?
  invoicePaidDate       DateTime?
  // Expense data
  projectName           String
  productionDate        DateTime
  clientBudget          Float         @default(0)
  paidAmount            Float         @default(0)
  totalItemBudgeted     Float         @default(0)
  totalItemDifferences  Float         @default(0)
  notes                 String?
  status                String        @default("draft")
  deletedAt             DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  sourceInvoiceId       String?       @unique
  sourceInvoice         Invoice?      @relation("GeneratedFromInvoice", fields: [sourceInvoiceId], references: [id], onDelete: SetNull)
  items                 ExpenseItem[]

  @@index([status, deletedAt])
  @@index([expenseId])
  @@index([productionDate])
  @@index([updatedAt])
  @@index([productionDate, status, deletedAt])
  @@index([status, updatedAt, deletedAt])
  @@index([invoiceId])
  @@index([invoiceNumber])
  @@index([sourceInvoiceId])
  // NEW: Optimized indexes for dashboard and financial calculations
  @@index([deletedAt, productionDate])          // Year-based expense queries
  @@index([deletedAt, updatedAt])               // Recent activity queries
  @@index([status, productionDate, deletedAt])  // Draft expenses by year
  @@index([productionDate, deletedAt, status])  // Monthly trends calculation
}

model ExpenseItem {
  id          String   @id @default(cuid())
  expenseId   String
  productName String
  budgeted    Float
  actual      Float
  difference  Float
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  expense     Expense  @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@index([productName])
  @@index([expenseId, order])
  // NEW: Optimized index for product expense aggregations
  @@index([expenseId, productName]) // Product-based expense calculations
}

model ParagonTicket {
  id                 String                @id @default(cuid())
  ticketId           String                @unique
  quotationId        String                @unique @default("")
  invoiceId          String                @unique @default("")
  companyName        String
  companyAddress     String
  companyCity        String
  companyProvince    String
  companyPostalCode  String?
  companyTelp        String?
  companyEmail       String?
  productionDate     DateTime
  quotationDate      DateTime
  invoiceBastDate    DateTime
  billTo             String
  contactPerson      String
  contactPosition    String
  bastContactPerson   String?   // BAST/Invoice contact (optional; falls back to contactPerson)
  bastContactPosition String?   // BAST/Invoice position (optional; falls back to contactPosition)
  signatureName      String
  signatureRole      String?
  signatureImageData String
  finalWorkImageData String?
  pph                String
  totalAmount        Float
  adjustmentPercentage Float?
  adjustmentNotes    String?
  termsAndConditions String?
  status             String                @default("draft")
  generatedInvoiceId String?
  deletedAt          DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  items              ParagonTicketItem[]
  remarks            ParagonTicketRemark[]

  @@index([status, deletedAt])
  @@index([ticketId])
  @@index([updatedAt])
  @@index([productionDate, status, deletedAt])
  @@index([status, updatedAt, deletedAt])
  @@index([companyName, status, deletedAt])
  // NEW: Optimized indexes for dashboard queries
  @@index([deletedAt, updatedAt])              // Recent activity queries
  @@index([productionDate, deletedAt])         // Year-based filtering
}

model ParagonTicketItem {
  id          String                    @id @default(cuid())
  ticketId    String
  productName String
  total       Float
  order       Int                       @default(0)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  ticket      ParagonTicket             @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  details     ParagonTicketItemDetail[]

  @@index([ticketId])
  @@index([ticketId, order])
}

model ParagonTicketItemDetail {
  id        String            @id @default(cuid())
  itemId    String
  detail    String
  unitPrice Float
  qty       Float
  amount    Float
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  item      ParagonTicketItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model ParagonTicketRemark {
  id          String        @id @default(cuid())
  ticketId    String
  text        String
  isCompleted Boolean       @default(false)
  order       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  ticket      ParagonTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([ticketId, order])
}

model ErhaTicket {
  id                     String             @id @default(cuid())
  ticketId               String             @unique
  quotationId            String             @unique @default("")
  invoiceId              String             @unique @default("")
  companyName            String
  companyAddress         String
  companyCity            String
  companyProvince        String
  companyPostalCode      String?
  companyTelp            String?
  companyEmail           String?
  productionDate         DateTime
  quotationDate          DateTime
  invoiceBastDate        DateTime
  billTo                 String
  billToAddress          String             @default("")
  contactPerson          String
  contactPosition        String
  bastContactPerson      String?   // BAST/Invoice contact (optional; falls back to contactPerson)
  bastContactPosition    String?   // BAST/Invoice position (optional; falls back to contactPosition)
  billingName            String
  billingBankName        String
  billingBankAccount     String
  billingBankAccountName String
  billingKtp             String?
  billingNpwp            String?
  signatureName          String
  signatureRole          String?
  signatureImageData     String
  finalWorkImageData     String?
  pph                    String
  totalAmount            Float
  adjustmentPercentage   Float?
  adjustmentNotes        String?
  termsAndConditions     String?
  status                 String             @default("draft")
  generatedInvoiceId     String?
  deletedAt              DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  items                  ErhaTicketItem[]
  remarks                ErhaTicketRemark[]

  @@index([status, deletedAt])
  @@index([ticketId])
  @@index([updatedAt])
  @@index([productionDate, status, deletedAt])
  @@index([status, updatedAt, deletedAt])
  @@index([companyName, status, deletedAt])
  // NEW: Optimized indexes for dashboard queries
  @@index([deletedAt, updatedAt])              // Recent activity queries
  @@index([productionDate, deletedAt])         // Year-based filtering
}

model ErhaTicketItem {
  id          String                 @id @default(cuid())
  ticketId    String
  productName String
  total       Float
  order       Int                    @default(0)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  ticket      ErhaTicket             @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  details     ErhaTicketItemDetail[]

  @@index([ticketId])
  @@index([ticketId, order])
}

model ErhaTicketItemDetail {
  id        String         @id @default(cuid())
  itemId    String
  detail    String
  unitPrice Float
  qty       Float
  amount    Float
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  item      ErhaTicketItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model ErhaTicketRemark {
  id          String     @id @default(cuid())
  ticketId    String
  text        String
  isCompleted Boolean    @default(false)
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  ticket      ErhaTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([ticketId, order])
}

model GearExpense {
  id        String    @id @default(cuid())
  name      String
  amount    Float
  date      DateTime?
  year      Int
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([year, deletedAt])
  // NEW: Optimized index for year-based filtering (most common query)
  @@index([deletedAt, year]) // Reverse order for better selectivity
}

model BigExpense {
  id        String    @id @default(cuid())
  name      String
  amount    Float
  date      DateTime?
  year      Int
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([year, deletedAt])
  // NEW: Optimized index for year-based filtering (most common query)
  @@index([deletedAt, year]) // Reverse order for better selectivity
}

model QuotationTemplate {
  id        String                  @id @default(cuid())
  name      String                  @unique
  deletedAt DateTime?
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  items     QuotationTemplateItem[]

  @@index([deletedAt])
}

model QuotationTemplateItem {
  id          String                        @id @default(cuid())
  templateId  String
  productName String
  createdAt   DateTime                      @default(now())
  updatedAt   DateTime                      @updatedAt
  template    QuotationTemplate             @relation(fields: [templateId], references: [id], onDelete: Cascade)
  details     QuotationTemplateItemDetail[]

  @@index([templateId])
}

model QuotationTemplateItemDetail {
  id        String                @id @default(cuid())
  itemId    String
  detail    String
  unitPrice Float
  qty       Float
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  item      QuotationTemplateItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model ProductionTracker {
  id             String    @id @default(cuid())
  trackerId      String    @unique
  expenseId      String
  invoiceId      String?
  projectName    String
  date           DateTime
  subtotal       Float     @default(0)
  totalAmount    Float     @default(0)
  expense        Float     @default(0)
  productAmounts Json      @default("{}")
  notes          String?
  status         String    @default("pending")
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([trackerId])
  @@index([expenseId])
  @@index([invoiceId])
  @@index([date])
  @@index([deletedAt])
  @@index([date, deletedAt])
  @@index([status])
  // NEW: Optimized indexes for common queries
  @@index([status, deletedAt])        // Status filtering
  @@index([deletedAt, date])          // Date range queries with soft delete
  @@index([expenseId, deletedAt])     // Expense lookup
}

